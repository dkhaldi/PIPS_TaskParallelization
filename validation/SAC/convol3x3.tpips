setproperty ABORT_ON_USER_ERROR TRUE
delete CONVOL
create CONVOL convol3x3.c include/SIMD.c

activate MUST_REGIONS
activate REGION_CHAINS
activate RICE_REGIONS_DEPENDENCE_GRAPH
activate PRECONDITIONS_INTER_FULL
activate TRANSFORMERS_INTER_FULL
setproperty RICEDG_STATISTICS_ALL_ARRAYS TRUE


setproperty LOOP_UNROLL_WITH_PROLOGUE FALSE
setproperty CONSTANT_PATH_EFFECTS FALSE
setproperty LOOP_UNROLL_MERGE TRUE
setproperty SIMDIZER_ALLOW_PADDING TRUE
setproperty COMPUTE_ALL_DEPENDENCES TRUE

echo
echo Initial code
echo

module main
display PRINTED_FILE
module convol
display PRINTED_FILE


setproperty SIMD_FORTRAN_MEM_ORGANISATION FALSE
setproperty SAC_SIMD_REGISTER_WIDTH 128
setproperty SIMD_AUTO_UNROLL_SIMPLE_CALCULATION FALSE
setproperty SIMD_AUTO_UNROLL_MINIMIZE_UNROLL FALSE
setproperty PRETTYPRINT_ALL_DECLARATIONS TRUE


apply PARTIAL_EVAL
apply LOOP_NORMALIZE
apply SIMPLIFY_CONTROL
display PRINTED_FILE

#source include/benchmark.tpips.h

#setproperty LOOP_LABEL "l200"
#apply REDUCTION_VARIABLE_EXPANSION
#display PRINTED_FILE
#
#setproperty ARRAY_TO_POINTER_CONVERT_PARAMETERS TRUE
#setproperty ARRAY_TO_POINTER_FLATTEN_ONLY TRUE
#apply ARRAY_TO_POINTER
#apply PARTIAL_EVAL
apply FLAG_LOOPS
#display PRINTED_FILE
##apply FLATTEN_CODE
setproperty LOOP_LABEL "l99997"
apply FULL_UNROLL
apply PARTIAL_EVAL
display PRINTED_FILE

#setproperty LOOP_LABEL "l99996"
#apply FULL_UNROLL
#apply PARTIAL_EVAL
#apply SIMPLIFY_CONTROL
#apply CLEAN_DECLARATIONS
#display PRINTED_FILE

apply SIMD_REMOVE_REDUCTIONS
display PRINTED_FILE


#setproperty EOLE_OPTIMIZATION_STRATEGY "CSE"
#apply OPTIMIZE_EXPRESSIONS
#apply CLEAN_DECLARATIONS
#display PRINTED_FILE
#
#setproperty EOLE_OPTIMIZATION_STRATEGY "ICM"
#apply OPTIMIZE_EXPRESSIONS
#apply PARTIAL_EVAL
##apply SIMPLIFY_CONTROL
#apply CLEAN_DECLARATIONS
#display PRINTED_FILE

#apply PARTIAL_EVAL
apply SIMD_ATOMIZER
display PRINTED_FILE


#apply DEATOMIZER
#apply PARTIAL_EVAL
#apply USE_DEF_ELIMINATION
#display PRINTED_FILE

apply SCALAR_RENAMING

display PRINTED_FILE

apply SIMDIZER

display PRINTED_FILE

#apply USE_DEF_ELIMINATION
#display PRINTED_FILE

apply DELAY_COMMUNICATIONS_INTRA
#apply INVARIANT_CODE_MOTION
#apply PARTIAL_REDUNDANCY_ELIMINATION
display PRINTED_FILE

#apply USE_DEF_ELIMINATION
apply CLEAN_DECLARATIONS
display PRINTED_FILE


echo
echo simdized code
echo

#display PRINTED_FILE
#setproperty EOLE_OPTIMIZATION_STRATEGY "CSE"
#apply OPTIMIZE_EXPRESSIONS
#apply CLEAN_DECLARATIONS
#display PRINTED_FILE

#setproperty EOLE_OPTIMIZATION_STRATEGY "ICM"
#apply OPTIMIZE_EXPRESSIONS
#apply PARTIAL_EVAL
#apply SIMPLIFY_CONTROL
#apply CLEAN_DECLARATIONS
#display PRINTED_FILE

apply UNSPLIT

close
delete CONVOL
quit
